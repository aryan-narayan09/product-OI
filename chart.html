<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Open Interest Chart</title>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; }
        .chip-container { display: flex; flex-wrap: wrap; gap: 5px; margin-bottom: 10px; }
        .chip { padding: 5px 10px; background-color: #f4f4f4; border: 1px solid #ddd; cursor: pointer; }
        .chip.selected { background-color: #007bff; color: white; }
        .product-row { margin-bottom: 10px; }
    </style>
</head>
<body>
    <h2>Open Interest Chart</h2>
    <div id="instrument-container"></div>
    <canvas id="chart"></canvas>
    
    <script>
        async function fetchData() {
            const response = await fetch("https://raw.githubusercontent.com/aryan-narayan09/product-OI/main/data.json");
            const data = await response.json();
            return data;
        }

        function createInstrumentChips(data) {
            const container = document.getElementById("instrument-container");
            container.innerHTML = "";
            
            const groupedData = {};
            data.forEach(({ Product, Instrument }) => {
                if (!groupedData[Product]) groupedData[Product] = new Set();
                groupedData[Product].add(Instrument);
            });

            Object.keys(groupedData).forEach(product => {
                const productRow = document.createElement("div");
                productRow.className = "product-row";
                productRow.innerHTML = `<strong>${product}</strong>`;
                
                const chipContainer = document.createElement("div");
                chipContainer.className = "chip-container";
                
                groupedData[product].forEach(instrument => {
                    const chip = document.createElement("div");
                    chip.className = "chip";
                    chip.textContent = instrument;
                    chip.dataset.instrument = instrument;
                    chip.dataset.product = product;
                    chip.addEventListener("click", toggleInstrumentSelection);
                    chipContainer.appendChild(chip);
                });
                
                productRow.appendChild(chipContainer);
                container.appendChild(productRow);
            });
        }

        function toggleInstrumentSelection(event) {
            event.target.classList.toggle("selected");
            updateChart();
        }

        async function updateChart() {
            const selectedInstruments = Array.from(document.querySelectorAll(".chip.selected"))
                .map(chip => ({ product: chip.dataset.product, instrument: chip.dataset.instrument }));
            
            const data = await fetchData();
            const chartData = {};
            
            selectedInstruments.forEach(({ product, instrument }) => {
                chartData[product] = chartData[product] || {};
                chartData[product][instrument] = [];
            });
            
            data.forEach(({ Product, Date, Instrument, "Open Interest": OpenInterest }) => {
                if (chartData[Product] && chartData[Product][Instrument]) {
                    chartData[Product][Instrument].push({ x: Date, y: OpenInterest });
                }
            });
            
            renderChart(chartData);
        }

        let chartInstance = null;
        function renderChart(chartData) {
            const ctx = document.getElementById("chart").getContext("2d");
            if (chartInstance) chartInstance.destroy();
            
            const datasets = [];
            const colors = ["red", "blue", "green", "purple", "orange", "brown"];
            let colorIndex = 0;
            
            const productAxes = {};
            let axisIndex = 0;
            
            Object.keys(chartData).forEach(product => {
                productAxes[product] = `y-axis-${axisIndex}`;
                axisIndex++;
                Object.keys(chartData[product]).forEach(instrument => {
                    datasets.push({
                        label: `${product} - ${instrument}`,
                        data: chartData[product][instrument],
                        borderColor: colors[colorIndex % colors.length],
                        backgroundColor: colors[colorIndex % colors.length],
                        yAxisID: productAxes[product],
                    });
                    colorIndex++;
                });
            });
            
            const chartOptions = {
                responsive: true,
                scales: {
                    x: { type: "time", time: { unit: "day" } },
                    ...Object.keys(productAxes).reduce((acc, product) => {
                        acc[productAxes[product]] = { type: "linear", display: true, position: "left" };
                        return acc;
                    }, {}),
                },
            };
            
            chartInstance = new Chart(ctx, {
                type: "line",
                data: { datasets },
                options: chartOptions,
            });
        }
        
        fetchData().then(createInstrumentChips);
    </script>
</body>
</html>
