<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Open Interest Data</title>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <link rel="stylesheet" href="https://cdn.datatables.net/1.13.6/css/jquery.dataTables.min.css">
    <script src="https://cdn.datatables.net/1.13.6/js/jquery.dataTables.min.js"></script>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; }
        table { width: 100%; border-collapse: collapse; margin-bottom: 30px; }
        th, td { border: 1px solid #ddd; padding: 8px; text-align: left; }
        th { background-color: #f4f4f4; }
        .highlight { background-color: #ffefc1; font-weight: bold; } /* Highlight last row */
    </style>
</head>
<body>

    <h2>Open Interest Data</h2>
    <div id="tables-container"></div>

    <script>
        async function fetchData() {
            const mainUrl = "https://raw.githubusercontent.com/aryan-narayan09/product-OI/main/data.json"; // Update this
            const currentUrl = "https://raw.githubusercontent.com/aryan-narayan09/product-OI/main/current_oi.json"; // Update this

            try {
                console.log("Fetching:", mainUrl);
                const mainResponse = await fetch(mainUrl);
                if (!mainResponse.ok) throw new Error("HTTP error " + mainResponse.status);
                const mainData = await mainResponse.json();

                console.log("Fetching:", currentUrl);
                const currentResponse = await fetch(currentUrl);
                if (!currentResponse.ok) throw new Error("HTTP error " + currentResponse.status);
                const currentData = await currentResponse.json();

                console.log("Fetched Data:", mainData);
                console.log("Fetched Current OI:", currentData);

                generateTables(mainData, currentData);
            } catch (error) {
                console.error("Fetch Error:", error);
                document.getElementById("tables-container").innerHTML = "Error loading data: " + error;
            }
        }

        function generateTables(mainData, currentData) {
            const container = document.getElementById("tables-container");
            container.innerHTML = ""; // Clear previous tables

            const groupedData = {};
            const instrumentOrder = {};
            const dateOrder = {};
            const currentOIMap = {}; // Store latest OI data

            // Process current_oi.json for quick lookup
            currentData.forEach(entry => {
                const product = entry["Product"];
                const instrument = entry["Instrument"];
                const openInterest = entry["Open Interest"];

                if (!currentOIMap[product]) currentOIMap[product] = {};
                currentOIMap[product][instrument] = openInterest;
            });

            // Process main JSON while maintaining order
            mainData.forEach(entry => {
                const product = entry["Product"];
                const date = entry["Date"];
                const instrument = entry["Instrument"];
                const openInterest = entry["Open Interest"];

                if (!groupedData[product]) {
                    groupedData[product] = {};
                    instrumentOrder[product] = [];
                    dateOrder[product] = [];
                }
                if (!groupedData[product][date]) {
                    groupedData[product][date] = {};
                    dateOrder[product].push(date); // Preserve date order
                }
                if (!instrumentOrder[product].includes(instrument)) {
                    instrumentOrder[product].push(instrument); // Preserve instrument order
                }

                groupedData[product][date][instrument] = openInterest;
            });

            // Generate tables
            Object.keys(groupedData).forEach((product, index) => {
                const productData = groupedData[product];
                const instruments = instrumentOrder[product]; // Use preserved order
                const dates = dateOrder[product]; // Use preserved order
                const tableId = `datatable-${index}`; // Unique ID for each table

                let tableHTML = `<h3>${product}</h3><table id="${tableId}" class="display"><thead><tr><th>Date</th>`;
                instruments.forEach(inst => tableHTML += `<th>${inst}</th>`);
                tableHTML += `</tr></thead><tbody>`;

                // Fill table rows using preserved date order
                dates.forEach(date => {
                    tableHTML += `<tr><td>${date}</td>`;
                    instruments.forEach(inst => {
                        tableHTML += `<td>${productData[date][inst] || "-"}</td>`;
                    });
                    tableHTML += `</tr>`;
                });

                // Append last row from current_oi.json
                tableHTML += `<tr class="highlight"><td>Latest</td>`;
                instruments.forEach(inst => {
                    const latestOI = currentOIMap[product]?.[inst] || "-";
                    tableHTML += `<td>${latestOI}</td>`;
                });
                tableHTML += `</tr>`;

                tableHTML += `</tbody></table>`;
                container.innerHTML += tableHTML;

                // Initialize DataTables for this table after it's added to the DOM
                setTimeout(() => {
                    $(`#${tableId}`).DataTable({
                        paging: false,   // Disable pagination
                        searching: false, // Disable search
                        ordering: false,  // Disable sorting (to preserve order)
                        info: false,      // Hide info text
                        autoWidth: false,
                        responsive: true
                    });
                }, 100);
            });
        }

        fetchData();
    </script>

</body>
</html>
