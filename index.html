<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Open Interest Data</title>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link rel="stylesheet" href="https://cdn.datatables.net/1.13.6/css/jquery.dataTables.min.css">
    <script src="https://cdn.datatables.net/1.13.6/js/jquery.dataTables.min.js"></script>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; }
        .container { display: flex; flex-wrap: wrap; align-items: flex-start; }
        .table-container, .chart-container { width: 50%; box-sizing: border-box; padding: 10px; }
        .table-container { overflow-y: auto; max-height: 90vh; }
        table { width: 100%; border-collapse: collapse; font-size: 12px; table-layout: fixed; }
        th, td { border: 1px solid #ddd; padding: 6px; text-align: center; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        th { background-color: #f4f4f4; }
        .toggle-btn { margin-bottom: 10px; cursor: pointer; padding: 5px 10px; border: 1px solid #ddd; background-color: #f4f4f4; }
        .chart-container { display: flex; justify-content: center; align-items: center; height: auto; }
        canvas { width: 100% !important; height: auto !important; max-height: 90vh; }
    </style>
</head>
<body>
    <h2>Open Interest Data</h2>
    <div id="content"></div>
    
    <script>
        async function fetchData() {
            const mainUrl = "https://raw.githubusercontent.com/aryan-narayan09/product-OI/main/data.json";
            try {
                const response = await fetch(mainUrl);
                if (!response.ok) throw new Error("HTTP error " + response.status);
                const mainData = await response.json();
                generateTables(mainData);
            } catch (error) {
                console.error("Fetch Error:", error);
                document.getElementById("content").innerHTML = "Error loading data: " + error;
            }
        }

        function generateTables(mainData) {
            const container = document.getElementById("content");
            container.innerHTML = "";
            const groupedData = {};
            
            mainData.forEach(entry => {
                const { Product, Date, Instrument, "Open Interest": OpenInterest } = entry;
                if (!groupedData[Product]) groupedData[Product] = {};
                if (!groupedData[Product][Instrument]) groupedData[Product][Instrument] = [];
                groupedData[Product][Instrument].push({ date: Date, openInterest: OpenInterest });
            });

            Object.keys(groupedData).forEach((product, index) => {
                const productData = groupedData[product];
                const tableId = `datatable-${index}`;
                const chartId = `chart-${index}`;
                const toggleId = `toggle-${index}`;
                
                let html = `<div class='container'>
                    <div class='table-container'>
                        <h3>${product} <button class='toggle-btn' id='${toggleId}'>Toggle % Change</button></h3>
                        <table id='${tableId}' class='display'>
                            <thead><tr><th>Date</th>`;
                
                let instruments = Object.keys(productData);
                instruments.forEach(inst => html += `<th class='instrument-column' data-product='${product}' data-instrument='${inst}'>${inst}</th>`);
                html += `<th>Total</th></tr></thead><tbody>`;
                
                let dates = [...new Set(Object.values(productData).flat().map(entry => entry.date))].sort();
                let totalRow = [];
                
                dates.forEach(date => {
                    html += `<tr><td>${date}</td>`;
                    let total = 0;
                    instruments.forEach(inst => {
                        let value = productData[inst].find(entry => entry.date === date)?.openInterest || 0;
                        total += value;
                        html += `<td>${value}</td>`;
                    });
                    html += `<td><strong>${total}</strong></td></tr>`;
                    totalRow.push(total);
                });
                
                html += `<tr><td><strong>Latest</strong></td>`;
                let latestTotal = 0;
                instruments.forEach(inst => {
                    let latestValue = productData[inst][productData[inst].length - 1]?.openInterest || 0;
                    latestTotal += latestValue;
                    html += `<td><strong>${latestValue}</strong></td>`;
                });
                html += `<td><strong>${latestTotal}</strong></td></tr>`;
                
                html += `</tbody></table></div>
                    <div class='chart-container'><canvas id='${chartId}'></canvas></div>
                </div>`;
                
                container.innerHTML += html;

                setTimeout(() => {
                    $(`#${tableId}`).DataTable({
                        paging: false,
                        searching: false,
                        ordering: false,
                        info: false,
                        autoWidth: false,
                        responsive: true,
                    });
                }, 100);

                document.querySelectorAll(`[data-product='${product}']`).forEach(el => {
                    el.addEventListener("click", () => {
                        const instrument = el.getAttribute("data-instrument");
                        updateChart(chartId, productData[instrument], instrument);
                    });
                });
            });
        }

        function updateChart(chartId, data, instrument) {
            const ctx = document.getElementById(chartId).getContext("2d");
            if (window[chartId]) window[chartId].destroy();
            window[chartId] = new Chart(ctx, {
                type: "line",
                data: {
                    labels: data.map(entry => entry.date),
                    datasets: [{
                        label: `Open Interest - ${instrument}`,
                        data: data.map(entry => entry.openInterest),
                        borderColor: "#007bff",
                        backgroundColor: "rgba(0, 123, 255, 0.1)",
                        borderWidth: 2,
                        fill: true,
                        tension: 0.1,
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        x: { title: { display: true, text: "Date" } },
                        y: { title: { display: true, text: "Open Interest" } }
                    }
                }
            });
        }
        
        fetchData();
    </script>
</body>
</html>
