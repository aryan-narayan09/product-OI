<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Open Interest Data</title>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link rel="stylesheet" href="https://cdn.datatables.net/1.13.6/css/jquery.dataTables.min.css">
    <script src="https://cdn.datatables.net/1.13.6/js/jquery.dataTables.min.js"></script>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; }
        .container { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; }
        .tables-container { overflow-x: auto; }
        .chart-container { display: flex; justify-content: center; align-items: center; }
        canvas { width: 100% !important; height: auto !important; }
        table { width: 100%; border-collapse: collapse; }
        th, td { border: 1px solid #ddd; padding: 8px; text-align: center; cursor: pointer; }
        th { background-color: #f4f4f4; }
        .toggle-btn { margin-bottom: 10px; cursor: pointer; padding: 5px 10px; border: 1px solid #ddd; background-color: #f4f4f4; }
    </style>
</head>
<body>
    <h2>Open Interest Data</h2>
    <div class="container">
        <div class="tables-container" id="tables-container"></div>
        <div class="chart-container">
            <canvas id="oiChart"></canvas>
        </div>
    </div>
    
    <script>
        async function fetchData() {
            const mainUrl = "https://raw.githubusercontent.com/aryan-narayan09/product-OI/main/data.json";
            try {
                const response = await fetch(mainUrl);
                if (!response.ok) throw new Error("HTTP error " + response.status);
                const mainData = await response.json();
                generateTables(mainData);
            } catch (error) {
                console.error("Fetch Error:", error);
                document.getElementById("tables-container").innerHTML = "Error loading data: " + error;
            }
        }

        function generateTables(mainData) {
            const container = document.getElementById("tables-container");
            container.innerHTML = "";
            const groupedData = {};
            
            mainData.forEach(entry => {
                const { Product, Date, Instrument, "Open Interest": OpenInterest } = entry;
                if (!groupedData[Product]) groupedData[Product] = {};
                if (!groupedData[Product][Instrument]) groupedData[Product][Instrument] = [];
                groupedData[Product][Instrument].push({ date: Date, value: OpenInterest });
            });
            
            Object.keys(groupedData).forEach((product, index) => {
                const productData = groupedData[product];
                const tableId = `datatable-${index}`;
                let tableHTML = `<h3>${product}</h3><table id='${tableId}' class='display'><thead><tr><th>Date</th>`;
                Object.keys(productData).forEach(inst => tableHTML += `<th>${inst}</th>`);
                tableHTML += `</tr></thead><tbody>`;
                
                const dates = [...new Set(Object.values(productData).flat().map(d => d.date))].sort();
                dates.forEach(date => {
                    tableHTML += `<tr><td>${date}</td>`;
                    Object.keys(productData).forEach(inst => {
                        const entry = productData[inst].find(d => d.date === date);
                        tableHTML += `<td class='oi-cell' data-product='${product}' data-instrument='${inst}'>${entry ? entry.value : '-'}</td>`;
                    });
                    tableHTML += `</tr>`;
                });
                
                tableHTML += `</tbody></table>`;
                const tableDiv = document.createElement("div");
                tableDiv.innerHTML = tableHTML;
                container.appendChild(tableDiv);
                
                setTimeout(() => {
                    $(`#${tableId}`).DataTable({ paging: false, searching: false, ordering: false, info: false });
                }, 100);
            });

            document.querySelectorAll('.oi-cell').forEach(cell => {
                cell.addEventListener('click', function () {
                    const product = this.dataset.product;
                    const instrument = this.dataset.instrument;
                    plotChart(product, instrument, groupedData);
                });
            });
        }
        
        function plotChart(product, instrument, groupedData) {
            const data = groupedData[product][instrument].sort((a, b) => new Date(a.date) - new Date(b.date));
            const labels = data.map(entry => entry.date);
            const values = data.map(entry => entry.value);
            
            if (window.oiChartInstance) window.oiChartInstance.destroy();
            
            const ctx = document.getElementById("oiChart").getContext("2d");
            window.oiChartInstance = new Chart(ctx, {
                type: "line",
                data: {
                    labels: labels,
                    datasets: [{
                        label: `${product} - ${instrument} Open Interest`,
                        data: values,
                        borderColor: "#007bff",
                        borderWidth: 2,
                        fill: false,
                        pointRadius: 3,
                        pointHoverRadius: 5
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: { x: { title: { display: true, text: "Date" } }, y: { title: { display: true, text: "Open Interest" } } },
                    plugins: { legend: { display: true } }
                }
            });
        }
        
        fetchData();
    </script>
</body>
</html>
